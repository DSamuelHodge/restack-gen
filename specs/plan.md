Here’s a crisp, developer-ready **work plan (issues by module)** plus a **clean PR sequence** so the repo spins up smoothly and merges stay low-risk.

# Minimal work plan (issues by module)

## A) CLI & scaffolding core (`restack_gen/cli.py`)

* [ ] Command skeletons: `new`, `g agent`, `g workflow`, `g function`, `g pipeline`, `run:server`, `doctor`
* [ ] Path resolution utilities (repo root, app name, snake/camel converters)
* [ ] Idempotent file writes (no overwrites without `--force`)
* [ ] Header marker detection (check if file generated by us)
* [ ] `--dry-run[=minimal|diff]` modes (list paths, show content, show diffs)
* [ ] Safe AST-based "edit-in-place" for `server/service.py` with `.patch` fallback
* [ ] Error UX & exit codes (developer-friendly messages)

## B) Templates (Jinja)

* [ ] Agent template: `@agent.defn`, `@agent.run`, sample `@agent.event`, `agent.step(...)`, `<AgentName>Event` enum
* [ ] Workflow template: `@workflow.defn`, typed `In/Out` models, import policies
* [ ] Function template: typed input + simple return
* [ ] Pipeline orchestrator template (seq / loop / cond patterns, loop limits from settings.yaml)
* [ ] `server/service.py` template (registry with queue grouping)
* [ ] `client/` samples (`schedule_agent.py`, `run_workflow.py`)
* [ ] `src/<app>/common/retries.py` with default policies
* [ ] `src/<app>/common/settings.py` with Pydantic settings (precedence: CLI > ENV > YAML)
* [ ] `src/<app>/common/compat.py` (Pydantic v1/v2 shim copied from generator)
* [ ] Tests templates (unit + integration with conftest.py fixtures)
* [ ] Project boilerplate (`pyproject.toml`, `Makefile`, `.env.example`, `config/settings.yaml`, `pre-commit`)
* [ ] All templates include header marker with timestamp + command

## C) Operator parser → IR → codegen

* [ ] Tokenizer for `WORD`, `→`, `⇄`, `→?` (and parse/validate `⊕` for v1.1)
* [ ] IR structure + validator (no orphan nodes; valid two-node loops; at least one sink)
* [ ] Renderer for **subworkflows** style (default) and **functions** style (flag)
* [ ] Hook points for per-step policy overrides (timeout/retry/heartbeat)
* [ ] `--map TOKEN:CustomName` for name overrides
* [ ] `--cond STEP:condition_fn` for custom conditional logic
* [ ] ASCII graph preview (optional, behind `--graph`)

## D) Service auto-registration

* [ ] Import insertion for agents/workflows/functions (AST-driven)
* [ ] List mutation (append unique entries; preserve sort; idempotent)
* [ ] Conflict detection (duplicate names, mismatched class/function symbols)
* [ ] `--task-queue` wiring

## E) Reliability defaults (policies)

* [ ] `DEFAULT_RETRY`, `DEFAULT_STEP_TIMEOUT`, `DEFAULT_HEARTBEAT`
* [ ] Enforce per call site: `child_execute(...)` / `workflow.step(...)`
* [ ] Optional `continue-as-new` toggle in long pipelines

## F) `restack doctor`

* [ ] Python & package checks (restack SDK, pydantic, typer, jinja2)
* [ ] Engine connectivity probe (configurable host)
* [ ] Import walk of `server/service.py` (catch broken registrations)
* [ ] Helpful guidance for fixes

## G) Observability & logging

* [ ] Minimal logging wrapper (run id, step id)
* [ ] Structured logs in templates (info/debug) with correlation IDs
* [ ] Toggle via env/config

## H) Tests & CI

* [ ] Unit tests for parser, IR validation, codegen
* [ ] Golden-file tests for templates (snapshot compare)
* [ ] Integration test: `restack new demo` → run server → execute sample workflow with stubs
* [ ] GitHub Actions (lint, type-check, tests), `pre-commit` hooks

## I) Docs & examples

* [ ] README quickstart
* [ ] Operator cheatsheet
* [ ] Example pipeline (BlogPipeline) with generated subworkflows
* [ ] Troubleshooting (doctor output glossary)

## J) Config & security

* [ ] `.env.example` and loader pattern (no secrets committed)
* [ ] `settings.yaml` + env overrides
* [ ] Namespacing & import hygiene

---

# Suggested PR order (small, linear, low-risk)

**PR 1 — Repo bootstrap & tooling**

* Scope: skeleton repo, `pyproject.toml`, `Makefile`, CI, `pre-commit`, empty `restack_gen/`.
* DoD: CI green; `make fmt/lint/test` no-ops succeed.

**PR 2 — Templates v1 (static)**

* Scope: Agent / Workflow / Function / Service / Client / Common policies / Tests templates (no CLI yet).
* Tests: Golden-file snapshots ensure templates render and import.
* DoD: `pytest -k templates` passes; `ruff/black` clean.

**PR 3 — CLI core: `new`**

* Scope: Implement `restack new <app>` using templates; write files & tree.
* Tests: Create temp dir, run CLI, assert paths/files exist & import clean.
* DoD: `restack new demo` produces a runnable skeleton; `pytest` inside the scaffold passes.

**PR 4 — CLI generate: `g agent|workflow|function`**

* Scope: Emit resource files and **update `server/service.py`** (AST insertion).
* Tests: Generate each resource; assert importable; assert service lists contain items (idempotent on second run).
* DoD: Repeated runs don’t duplicate; server imports succeed.

**PR 5 — Operator parser → IR**

* Scope: Tokenizer + IR + validator; no codegen yet.
* Tests: Valid/invalid strings; edge cases (multiple loops, missing sinks).

**PR 6 — Pipeline codegen (functions style)**

* Scope: Render orchestrator + step functions from IR; apply default policies.
* Tests: Golden snapshot; unit tests verify options (retry/timeout/heartbeat) attached.
* DoD: Generated pipeline imports; unit tests pass.

**PR 7 — Pipeline codegen (subworkflows style)**

* Scope: Render orchestrator + subworkflow classes; use `child_execute(...)`.
* Tests: Same as PR 6 plus orchestrator calling pattern verification.
* DoD: Integration test runs full pipeline with stubs.

**PR 8 — Reliability hardening**

* Scope: Continue-as-new hook, policy overrides (CLI flags), heartbeat default wiring.
* Tests: Generation with overrides; verify emitted options; long-run checkpoint unit.

**PR 9 — `restack doctor`**

* Scope: Engine probe, import walk, config checks, file permissions, package versions, git status, readable output.
* Tests: Mock engine unreachable; ensure actionable guidance.
* DoD: Detects uncommitted git changes, package version mismatches, permission issues.

**PR 10 — Observability pass**

* Scope: Logging wrapper; inject into templates; correlation IDs.
* Tests: Log lines contain run/step IDs; toggle via env.

**PR 11 — Docs & examples**

* Scope: README quickstart; operator cheatsheet; BlogPipeline example repo under `examples/`.
* DoD: Follow README from scratch → success.

**PR 12 — Polish & safeguards**

* Scope: `--force` semantics; better error messages; edge-case idempotency.
* Tests: Overwrite protection; conflict detection (duplicate names).

---

# Definition of Done (release checklist)

* [ ] `pipx install` works and exposes `restack` CLI.
* [ ] `restack new demo && cd demo && restack run:server` starts service.
* [ ] `restack g agent Hello`, `g workflow HelloFlow`, `g function SendEmail` generate code and self-register.
* [ ] `restack g pipeline BlogPipeline --operators "IDEATE ⇄ RESEARCH → PLAN → OUTLINE → DRAFT ⇄ REVIEW → POLISH → PUBLISH → PROMOTE →? REPURPOSE" --style subworkflows` runs end-to-end with default retries/timeouts/heartbeats.
* [ ] `restack doctor` produces clear diagnostics for common failure modes.
* [ ] CI: lint, type-check, unit + integration tests all green.
* [ ] Docs let a new dev succeed from zero without help.


