Here are **clear defaults** and **rationales** so your team can implement without ping-pong.

# Architecture & Technical Decisions

* **Python version:** **3.11+**
  *Why:* better task-group semantics & performance, widespread support, and keeps us future-proof. (We won’t rely on 3.12-only features yet.)

* **Pydantic version:** **v2**
  *Why:* faster, stable, and it’s where the ecosystem is headed. If the Restack SDK pins v1, we’ll add a thin compat shim; otherwise default to v2.

* **Generator distribution:** **Standalone `pipx` CLI (separate repo)** + **project-scoped runner**
  *Plan:* ship `restack` as a pipx-installable tool. Each generated project also gets a tiny wrapper script (`bin/restack-local`) that simply shells to the global CLI—so teams can pin version via `tool-versions`/`uv`/`poetry` if they want. We will **not** copy the generator into projects.

# CLI & UX

* **Naming conventions (operators → code):**

  * Token `IDEATE` → class `IdeateWorkflow`, file `ideate_workflow.py`.
  * Provide `--map IDEATE:CustomIdeate` to override names when needed.
  * CamelCase for classes, snake_case files, `*Workflow` suffix for subworkflows in pipeline style.

* **Idempotency for `g` commands:**

  * Default: **skip with a warning** if target exists.
  * `--force` to overwrite.
  * `--dry-run` to preview writes.

* **Task queue naming:**

  * Default queue: `"restack"`.
  * **Configurable per resource** via `--task-queue` flag at generation time **and** overridable in `settings.yaml`.
  * `server/service.py` respects resource-level queue if set; else falls back to default.

# Operator Grammar

* **Conditional (`→?`):**

  * Default: checks a **boolean field on the previous step’s output**, e.g., `should_repurpose: bool`.
  * Generator also emits an **optional stub function** (e.g., `should_repurpose(prev: Model) -> bool`) and wires it—commented in code—so teams can switch to logic-based conditions easily.
  * CLI supports `--cond PUBLISH:repurpose_condition` to name a condition function.

* **Loop termination (`⇄`):**

  * Both:

    * **Max iterations** with default `MAX_<PAIR>_LOOPS = 3`.
    * Generated `should_continue_<pair>(state) -> bool` stub (returns False by default).
  * Either condition ending the loop (boolean stub or max-loops) stops refinement.

* **Future parallel (`⊕`):**

  * **Parse & validate in v1** (so grammar is stable), but **codegen lands in v1.1**.
  * In v1, we emit a `# TODO(parallel fan-out)` comment block where it would go.

# Reliability & Policies

* **Policy customization:**

  * **Generation-time flags** for defaults (retry/timeout/heartbeat).
  * **Runtime-configurable in `config/settings.yaml`** (these override code defaults).
  * Generated code contains **clear TODO comments** showing where to alter per-step options.

* **Continue-as-new:**

  * We **generate commented-out checkpoints** at sensible boundaries (e.g., after publish) **and** allow a `settings.yaml` threshold (`continue_as_new_after_steps`).
  * No special grammar annotation needed for v1; we can consider `→↻` later.

# Service Registration

* **Auto-registration safety:** **AST manipulation** with a fallback guard.
  *Why:* safest against formatting & import-order issues. If AST fails (edge cases), we abort with a clear message and suggested manual snippet.

* **Resource deletion:**

  * v1: **manual** (delete file + remove from `service.py`).
  * We’ll document the steps. A `restack destroy` could come later once AST removal is robust.

# Testing

* **Integration tests:** **Both**, behind an env flag.

  * Default: **mock/stub mode** (no engine required).
  * If `RESTACK_ENGINE_URL` is set (or `--engine-url`), also run **engine-backed** integration test.

* **Fixtures:**

  * Yes: generate `tests/conftest.py` with mock client, sample inputs, and policy fixtures.

# Config & Secrets

* **Settings schema:**

  * **Typed Pydantic settings** model wrapping `settings.yaml`. Env overrides supported.
  * This enforces correctness while keeping YAML human-friendly.

* **Engine connection:** priority order:

  1. CLI flag `--engine-url`
  2. `RESTACK_ENGINE_URL` env var
  3. `settings.yaml` value
     (First non-empty wins.)

# Workflow Specifics

* **Workflow I/O model placement:**

  * **Same file** as the workflow by default (best locality).
  * Optional `--models external` puts them into `src/<app>/models.py` if teams prefer consolidation.

* **Agent event types:**

  * Generate a **`Enum` registry** per agent file (e.g., `class OnboardingEvent(str, Enum): messages="messages", end="end"`), and use it in signatures.
  * Still accept raw strings for flexibility.

# Edge Cases

* **Duplicate detection:**

  * If a target file exists and **was not generated by us** (no header marker), **error out** with a clear message.
  * If our header marker is present, follow the idempotency rules (skip/warn unless `--force`).

* **Template migration/versioning:**

  * v1: **manual migration guide** + `restack doctor` hints.
  * We’ll add `restack upgrade` later when we have telemetry on common diffs.

---

## Small examples (for clarity)

**Generated header marker (top of files):**

```python
# @generated by restack-gen v1.0.0 — DO NOT EDIT HEADER
# To regenerate: restack g workflow IdeateWorkflow
```

**Per-step policy injection site:**

```python
result = await child_execute(
    IdeateWorkflow,
    input=IdeateIn(topic=input.topic),
    options={
        "retry_policy": settings.retry.default_policy,
        "start_to_close_timeout": settings.retry.default_timeout,
        "heartbeat_timeout": settings.retry.default_heartbeat,
    },
)
```

**Settings precedence note in README:**

```
CLI flag > ENV (RESTACK_ENGINE_URL, RETRY_*) > settings.yaml > code defaults
```

---

## TL;DR decisions list (copy into the project README)

* Python **3.11+**, Pydantic **v2**
* Generator: **standalone pipx tool**, not vendored into projects
* Naming: Token → `*Workflow` class & `_workflow.py` file; `--map` for overrides
* Idempotency: **skip w/ warning**; `--force` to overwrite
* Task queues: default `"restack"`, **per-resource configurable**
* Condition (`→?`): previous step’s boolean + optional stub function
* Loop (`⇄`): **max loops + stub condition**, either can stop
* Parallel (`⊕`): parse/validate now, codegen later
* Policies: flags at generation time **and** `settings.yaml` runtime overrides
* Continue-as-new: commented checkpoints + optional settings threshold
* Auto-registration: **AST**; error if unsafe; manual snippet fallback
* Destroy: manual (documented)
* Tests: stubs by default; engine-backed when `--engine-url` or env set
* Config: Pydantic settings model; env & CLI override YAML
* Models: same file by default; `--models external` supported
* Events: generate `Enum` registry but allow strings
* Duplicates: error if not ours; otherwise follow overwrite rules
* Upgrades: manual guide (v1), later `restack upgrade`


