Here‚Äôs a clean, ready-to-commit **`/docs/DECISIONS.md`** draft reflecting all the architectural and design decisions for the Rails-style Restack agent generator ‚Äî updated to recommend `uv pip install` over `pipx`.

---

# üß≠ Rails-Style Restack Agent Generator ‚Äî Decisions Log

This document captures the **core architectural and implementation decisions** for the `restack` scaffolding CLI.
It serves as a **single source of truth** for contributors, maintainers, and new developers joining the project.

---

## 1. Platform & Language Decisions

| Area           | Decision                           | Rationale                                                                                                          |
| -------------- | ---------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| Python         | **3.11+**                          | Modern async features, stable ecosystem, better performance.                                                       |
| Pydantic       | **v2**                             | Faster and more idiomatic. We‚Äôll provide a thin shim if the Restack SDK pins v1.                                   |
| Install method | `uv pip install restack-gen`       | `uv` is now preferred over `pipx` for global CLI installs in many modern Python workflows.                         |
| Distribution   | **Standalone CLI** (`restack-gen`) | Installed globally, not vendored into generated projects. A local wrapper is generated for pinned usage if needed. |

---

## 2. Naming Conventions

| Element                | Convention                                    | Example                     |
| ---------------------- | --------------------------------------------- | --------------------------- |
| Operator token ‚Üí class | CamelCase + `Workflow` suffix                 | `IDEATE` ‚Üí `IdeateWorkflow` |
| Operator token ‚Üí file  | snake_case + `_workflow.py` suffix            | `ideate_workflow.py`        |
| Override               | `--map IDEATE:CustomIdeate`                   | Supports custom mappings    |
| Task queues            | Default: `restack`; per-resource configurable | `--task-queue email_queue`  |

---

## 3. CLI Behavior & Idempotency

* Running `restack g agent Hello` twice:

  * If generated by us ‚Üí **skip with warning**.
  * If not generated by us ‚Üí **error**.
  * Use `--force` to overwrite.
* `--dry-run` previews file creation without writing.
* `--task-queue` overrides default queue at generation time.

---

## 4. Operator Grammar

### Supported Operators (v1)

| Operator | Meaning                                 | Example                |
| -------- | --------------------------------------- | ---------------------- |
| `‚Üí`      | Sequential execution                    | `IDEATE ‚Üí PLAN`        |
| `‚áÑ`      | Refinement loop (bounded + conditional) | `DRAFT ‚áÑ REVIEW`       |
| `‚Üí?`     | Conditional step                        | `PUBLISH ‚Üí? REPURPOSE` |

### Planned (v1.1)

| Operator | Meaning          |
| -------- | ---------------- |
| `‚äï`      | Parallel fan-out |

### Conditional Logic (`‚Üí?`)

* Default: previous step returns a boolean field (e.g., `should_repurpose`).
* Generator emits stub function for custom logic.
* Optional `--cond PUBLISH:repurpose_condition` flag.

### Loop Logic (`‚áÑ`)

* Defaults:

  * `MAX_<PAIR>_LOOPS = 3`
  * Stub `should_continue_<pair>(state) -> bool` emitted.
* Loop ends on max iterations or condition false.

### Parallel Logic (`‚äï`)

* Parsed and validated in v1.
* Codegen deferred to v1.1 (emits TODO comment in orchestrator).

---

## 5. Reliability & Policies

| Policy    | Default                                  | Configurable                         |
| --------- | ---------------------------------------- | ------------------------------------ |
| Retry     | Exponential backoff: 5s ‚Üí 2m, 6 attempts | Generation-time flags, settings.yaml |
| Timeout   | 2 min                                    | flags / settings.yaml                |
| Heartbeat | 30 s                                     | flags / settings.yaml                |

* Per-step overrides allowed via CLI and `settings.yaml`.
* Continue-as-new:

  * Commented checkpoints auto-inserted in orchestrator.
  * Optional threshold in `settings.yaml`.
  * No grammar annotation in v1.

---

## 6. Code Registration

* Auto-registration in `server/service.py` uses **AST manipulation** (safe, idempotent).
* If AST fails, generator aborts with a **clear message**.
* No `restack destroy` in v1 ‚Äî deletion is manual (documented).
* Resource files have a header marker:

  ```python
  # @generated by restack-gen v1.0.0 ‚Äî DO NOT EDIT HEADER
  ```

---

## 7. Testing Strategy

| Type                  | Behavior                       | Engine                                     |
| --------------------- | ------------------------------ | ------------------------------------------ |
| Unit                  | Parser, IR, template snapshots | N/A                                        |
| Integration (default) | Mocks/stubs                    | Offline                                    |
| Integration (opt-in)  | Real engine                    | Set `RESTACK_ENGINE_URL` or `--engine-url` |

* `tests/conftest.py` includes fixtures and mocks.
* CLI flag/env overrides engine host.

---

## 8. Configuration & Secrets

* `settings.yaml` is typed with **Pydantic Settings**.
* Precedence:

  1. CLI flag `--engine-url`
  2. `RESTACK_ENGINE_URL` env var
  3. `settings.yaml`
* Secrets managed via environment, not committed.
* Retry/timeouts/queues configurable in `settings.yaml`.

---

## 9. Workflow & Agent Structure

| Resource | I/O Models                                                                | Events                |
| -------- | ------------------------------------------------------------------------- | --------------------- |
| Workflow | In/Out models in same file (default) or external with `--models external` |                       |
| Agent    | Event enum generated                                                      | Strings still allowed |

---

## 10. Edge Cases

* Duplicate resource name:

  * If generated file (header present): skip or overwrite with `--force`.
  * If non-generated: error.
* Upgrade path:

  * v1: manual migration guide.
  * Future: `restack upgrade`.

---

## 11. Installation & Usage

```bash
# Global install
uv pip install restack-gen

# Create new project
restack new myapp

# Generate resources
restack g agent Hello
restack g workflow BlogWorkflow
restack g pipeline BlogPipeline --operators "IDEATE ‚áÑ RESEARCH ‚Üí PLAN ‚Üí OUTLINE ‚Üí DRAFT ‚áÑ REVIEW ‚Üí POLISH ‚Üí PUBLISH ‚Üí PROMOTE ‚Üí? REPURPOSE"

# Run server
restack run:server
```

---

## 12. Default File Layout

```
myapp/
  config/
    settings.yaml
  server/
    service.py
  client/
    run_workflow.py
  src/myapp/
    agents/
    workflows/
    functions/
    common/
      retries.py
  tests/
  docs/
    DECISIONS.md
```

---

## 13. Testing & CI

* CI runs: lint, typecheck, unit tests, offline integration tests.
* `--engine-url` enables online integration.
* Golden file tests ensure templates remain stable.

---

## 14. Future Extensions

* [ ] `‚äï` parallel operator codegen
* [ ] `restack destroy` support
* [ ] `restack upgrade` migration tooling
* [ ] Web UI for operator pipelines
* [ ] Visual DAG output

---

## 15. Decision Record Tags

| Tag           | Meaning                               |
| ------------- | ------------------------------------- |
| `ARCH`        | Architecture                          |
| `CLI`         | User interface / developer experience |
| `GRAMMAR`     | Operator grammar                      |
| `RELIABILITY` | Retries, fault tolerance              |
| `TESTING`     | Testing & CI                          |
| `CONFIG`      | Configuration & secrets               |
| `STRUCTURE`   | File layout and naming                |
| `FUTURE`      | Deferred work                         |

---

‚úÖ **Last updated:** 2025-10-24
‚úçÔ∏è Maintainers: Core Engineering Team
üìú Version: 1.0.0


# Final Clarifications & Decisions

## Pydantic v2 Compat Shim

* **Location:** `restack_gen/compat.py` (inside the generator).
* **Usage:** Templates import from `src/<app>/common/compat.py`, which is **generated** by copying from `restack_gen/compat.py` at project creation.

  * This gives us one authoritative shim, while keeping projects self-contained.
* **Behavior:** Provide `from restack_compat import BaseModel, Field, SettingsBase` that proxies to v2 (or adapts v1‚Üív2 signatures). Generated files import from `src/<app>/common/compat.py` only.

## Generated Header Marker

* **Include timestamp + generator version + command.**
* **Format (top 3 lines of every generated file):**

  ```python
  # @generated by restack-gen v1.0.0 (2025-10-24T14:05:12Z)
  # command: restack g workflow BlogWorkflow --task-queue restack
  # do not edit this header; use --force to overwrite
  ```
* **Optional hash:** not required in v1 (timestamp + command are enough). We can add a hash in v1.1 if needed.

## AST Manipulation Fallback

* **Behavior (in order):**

  1. Print a **clear error** explaining what failed.
  2. Print the **exact snippet** to paste.
  3. Also write a `server/service.py.patch` with a **unified diff**.
  4. Exit with non-zero status and a short ‚ÄúHow to apply‚Äù note.
* This covers both quick manual fixes and patch-apply workflows.

## Settings Precedence in Code

* **Keep precedence logic in the Settings loader**, not scattered in each call site.
* Generated code should **trust `settings`** to be resolved.
* We‚Äôll still include a **comment** near the settings import reminding devs of precedence:

  ```
  # Precedence: CLI > ENV > settings.yaml > code defaults (see Settings.load())
  ```

## Enum Registry Naming (Agent Events)

* **Singular:** `<AgentName>Event` (e.g., `OnboardingEvent`).

  * Clearer when referenced (`OnboardingEvent.messages`).
  * Plural is tempting but reads oddly in code; `Events` is too generic.

## Loop Max Iterations Location

* **In `settings.yaml`** under a namespaced key.

  * Example:

    ```yaml
    pipeline:
      loops:
        ideate_research:
          max: 3
        draft_review:
          max: 3
    ```
* The orchestrator reads these via `settings.pipeline.loops.ideate_research.max`, with a **code fallback constant** (e.g., `DEFAULT=3`) if missing.

## `--dry-run` Output

* **Do all three:**

  1. **List file paths** that would be created/modified.
  2. Show **full rendered content** for new files (paginated if large).
  3. If a file exists, show a **unified diff** (colorized).
* Provide `--dry-run=minimal` to only list paths, and `--dry-run=diff` to suppress full contents.

## External Models Flag (`--models external`)

* **Single consolidated file:** `src/<app>/models.py` by default.
* Allow optional `--models split` to place in:

  * `src/<app>/models_workflows.py`
  * `src/<app>/models_agents.py`
* The default keeps discovery simple; the split option helps larger teams.

## Task Queue Handling in `service.py`

* **Group resources by queue** and **call `start_service` once per queue** (i.e., multiple calls).

  * This mirrors how queue-level scaling/ops usually works.
* If the Restack SDK later supports multi-queue in one call, we can fold it into a single call transparently; our grouping logic still stands.

## `restack doctor` Scope

* **Yes** to all three:

  * **File permissions:** verify write access to project directories; warn if not.
  * **Python package versions:** check **exact versions** (not just presence) for key deps and warn if out of compatible range.
  * **Git status:** if a Git repo is present and there are **uncommitted changes**, warn before generation or overwrites; suggest `--force` or committing first.

---

## Tiny snippets to anchor behavior

### Settings loader (precedence centralized)

```python
# src/<app>/common/settings.py
from .compat import SettingsBase, Field  # shimmed pydantic base
import os

class RetrySettings(SettingsBase):
    initial_seconds: float = 5.0
    backoff: float = 2.0
    max_interval_seconds: float = 120.0
    max_attempts: int = 6

class LoopLimits(SettingsBase):
    ideate_research_max: int = 3
    draft_review_max: int = 3

class AppSettings(SettingsBase):
    engine_url: str | None = Field(default=None)
    task_queue_default: str = "restack"
    retry: RetrySettings = RetrySettings()
    loops: LoopLimits = LoopLimits()

    @classmethod
    def load(cls, cli_engine_url: str | None = None) -> "AppSettings":
        # Order: CLI > ENV > YAML > defaults
        y = cls.from_yaml("config/settings.yaml")  # implemented in compat for v1/v2
        env_url = os.getenv("RESTACK_ENGINE_URL")
        y.engine_url = cli_engine_url or env_url or y.engine_url
        return y

settings = AppSettings.load()
```

### Header marker example (top of generated file)

```python
# @generated by restack-gen v1.0.0 (2025-10-24T14:05:12Z)
# command: restack g agent Onboarding --task-queue onboarding_q
# do not edit this header; use --force to overwrite
```

### Doctor checks (summary output)

```
Doctor
‚úì Python 3.11.8
‚úì restack-ai 1.2.3 (compatible)
! pydantic 2.6.4 (recommended >=2.7.0)
‚úì Write access: src/, server/, client/, tests/
! Git: 3 unstaged files (commit or use --force)
‚úì Engine reachable at http://localhost:7700
```

